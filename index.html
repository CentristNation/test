<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Education ZIP Dashboard â€” Advanced Analytics</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
  * {
    box-sizing: border-box;
  }
  
  html, body {
    height: 100%;
    margin: 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  #app {
    display: flex;
    height: 100vh;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    margin: 10px;
    overflow: hidden;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
  }
  
  #map {
    flex: 1;
    border-radius: 15px 0 0 15px;
    position: relative;
    overflow: hidden;
  }
  
  #sidebar {
    width: 450px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-left: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    flex-direction: column;
    border-radius: 0 15px 15px 0;
    overflow: hidden;
  }
  
  .header {
    padding: 24px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  h1 {
    font-size: 24px;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .tab-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .tab-nav {
    display: flex;
    background: rgba(255, 255, 255, 0.9);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .tab-button {
    flex: 1;
    padding: 16px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: #64748b;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .tab-button.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .tab-button:hover:not(.active) {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
  }
  
  .tab-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: none;
  }
  
  .tab-content.active {
    display: block;
  }
  
  .section {
    margin-bottom: 24px;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .section-title {
    font-size: 16px;
    font-weight: 600;
    color: #334155;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .button-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  }
  
  button:active {
    transform: translateY(0);
  }
  
  #clearSel {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
  }
  
  #clearSel:hover {
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
  }
  
  .buffer-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 12px;
  }
  
  #bufferRadius {
    width: 80px;
    padding: 8px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    font-size: 13px;
    background: rgba(255, 255, 255, 0.8);
  }
  
  #bufferRadius:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .filter-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  label {
    font-size: 13px;
    font-weight: 500;
    min-width: 100px;
    color: #475569;
  }
  
  input[type=number] {
    width: 80px;
    padding: 8px 10px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    font-size: 13px;
    background: rgba(255, 255, 255, 0.8);
    transition: all 0.3s ease;
  }
  
  input[type=number]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .basemap-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    gap: 8px;
  }
  
  .basemap-btn {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }
  
  .basemap-btn.streets {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
  }
  
  .basemap-btn.satellite {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
  }
  
  .basemap-btn.dark {
    background: linear-gradient(135deg, #374151 0%, #111827 100%);
    color: white;
  }
  
  .basemap-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  }
  
  table.dataTable {
    font-size: 12px;
    border-radius: 12px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.9);
    width: 100% !important;
  }
  
  table.dataTable thead th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 8px;
    font-weight: 600;
    font-size: 12px;
  }
  
  table.dataTable tbody td {
    padding: 10px 8px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    font-size: 12px;
  }
  
  table.dataTable tbody tr:hover {
    background: rgba(102, 126, 234, 0.1);
  }
  
  .chart-container {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
  }
  
  .chart-title {
    font-size: 14px;
    font-weight: 600;
    color: #334155;
    margin-bottom: 12px;
    text-align: center;
  }
  
  canvas {
    max-height: 250px;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  
  .stat-card {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #667eea;
    display: block;
  }
  
  .stat-label {
    font-size: 12px;
    color: #64748b;
    margin-top: 4px;
  }
  
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #667eea;
    font-size: 16px;
  }
  
  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  }
  
  .leaflet-popup-content table {
    margin: 0;
    font-size: 13px;
  }
  
  .leaflet-popup-content table td {
    padding: 6px 8px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .leaflet-popup-content table td:first-child {
    font-weight: 600;
    color: #667eea;
  }
  
  .buffer-mode {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
  }
  
  .buffer-mode:hover {
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  .pulsing {
    animation: pulse 2s infinite;
  }
</style>
</head>
<body>
<div id="app">
  <div id="map">
    <div class="basemap-controls">
      <button class="basemap-btn streets" data-basemap="streets" title="Streets">
        <i class="fas fa-map"></i>
      </button>
      <button class="basemap-btn satellite" data-basemap="satellite" title="Satellite">
        <i class="fas fa-satellite"></i>
      </button>
      <button class="basemap-btn dark" data-basemap="dark" title="Dark">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </div>
  <div id="sidebar">
    <div class="header">
      <h1><i class="fas fa-graduation-cap"></i>Education Analytics</h1>
    </div>
    
    <div class="tab-container">
      <div class="tab-nav">
        <button class="tab-button active" data-tab="tools">
          <i class="fas fa-tools"></i>Tools
        </button>
        <button class="tab-button" data-tab="data">
          <i class="fas fa-table"></i>Data
        </button>
        <button class="tab-button" data-tab="charts">
          <i class="fas fa-chart-bar"></i>Charts
        </button>
      </div>
      
      <div id="tools-tab" class="tab-content active">
        <div class="section">
          <div class="section-title">
            <i class="fas fa-draw-polygon"></i>Selection Tools
          </div>
          <div class="button-group">
            <button id="drawRect"><i class="fas fa-square"></i>Rectangle</button>
            <button id="drawPoly"><i class="fas fa-draw-polygon"></i>Polygon</button>
            <button id="bufferTool"><i class="fas fa-circle"></i>Buffer</button>
            <button id="clearSel"><i class="fas fa-trash"></i>Clear</button>
          </div>
          <div class="buffer-controls">
            <label for="bufferRadius">Buffer (km):</label>
            <input type="number" id="bufferRadius" value="5" min="0.1" max="50" step="0.1">
            <span style="font-size: 12px; color: #64748b;">Click map to select</span>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">
            <i class="fas fa-filter"></i>Data Filters
          </div>
          <div id="filters"></div>
        </div>
        
        <div class="section">
          <div class="section-title">
            <i class="fas fa-chart-bar"></i>Quick Stats
          </div>
          <div class="stats-grid" id="quickStats"></div>
        </div>
      </div>
      
      <div id="data-tab" class="tab-content">
        <div class="section">
          <div class="section-title">
            <i class="fas fa-table"></i>Selected Areas Summary
          </div>
          <table id="summary" class="display" width="100%">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <div id="charts-tab" class="tab-content">
        <div class="section">
          <div class="section-title">
            <i class="fas fa-chart-line"></i>Data Visualizations
          </div>
          <div class="chart-container">
            <div class="chart-title">Count Totals</div>
            <canvas id="countChart"></canvas>
          </div>
          <div class="chart-container">
            <div class="chart-title">Percentage Averages</div>
            <canvas id="pctChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://cdn.jsdelivr.net/npm/turf@6.5.0/turf.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

<script>
(async function(){
  // Tab functionality
  function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTab = button.dataset.tab;
        
        // Update button states
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        // Update content visibility
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === `${targetTab}-tab`) {
            content.classList.add('active');
          }
        });
      });
    });
  }
  
  initTabs();
  
  // Show loading state
  document.getElementById('tools-tab').innerHTML = '<div class="loading pulsing"><i class="fas fa-spinner fa-spin"></i> Loading education data...</div>';
  
  try {
    // Multiple fallback methods to load the GeoJSON data
    const GEOJSON_URLS = [
      "education-data.geojson",  // Relative path (primary)
      "https://centristnation.github.io/test/education-data.geojson",  // Direct GitHub Pages URL
      "https://raw.githubusercontent.com/centristnation/test/main/education-data.geojson"  // Raw GitHub URL
    ];
    
    let geojson;
    let features;
    let loadSuccess = false;
    
    // Try each URL until one works
    for (const url of GEOJSON_URLS) {
      try {
        console.log(`Trying to load: ${url}`);
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        geojson = await res.json();
        features = geojson.features;
        console.log(`Successfully loaded from: ${url}`);
        console.log(`Found ${features.length} features`);
        loadSuccess = true;
        break;
      } catch (error) {
        console.warn(`Failed to load from ${url}:`, error.message);
        continue;
      }
    }
    
    if (!loadSuccess) {
      throw new Error('Could not load GeoJSON from any source');
    }

    // Restore tools tab content
    document.getElementById('tools-tab').innerHTML = `
      <div class="section">
        <div class="section-title">
          <i class="fas fa-draw-polygon"></i>Selection Tools
        </div>
        <div class="button-group">
          <button id="drawRect"><i class="fas fa-square"></i>Rectangle</button>
          <button id="drawPoly"><i class="fas fa-draw-polygon"></i>Polygon</button>
          <button id="bufferTool"><i class="fas fa-circle"></i>Buffer</button>
          <button id="clearSel"><i class="fas fa-trash"></i>Clear</button>
        </div>
        <div class="buffer-controls">
          <label for="bufferRadius">Buffer (km):</label>
          <input type="number" id="bufferRadius" value="5" min="0.1" max="50" step="0.1">
          <span style="font-size: 12px; color: #64748b;">Click map to select</span>
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">
          <i class="fas fa-filter"></i>Data Filters
        </div>
        <div id="filters"></div>
      </div>
      
      <div class="section">
        <div class="section-title">
          <i class="fas fa-chart-bar"></i>Quick Stats
        </div>
        <div class="stats-grid" id="quickStats"></div>
      </div>
    `;

    // Detect ZIP + numeric fields
    const sampleProps = features[0].properties;
    const zipKey = Object.keys(sampleProps).find(k => /zip/i.test(k));
    const numericFields = Object.keys(sampleProps).filter(k => 
      typeof sampleProps[k] === 'number' && k !== zipKey
    );

    // State management
    const state = {
      filters: {},
      selectedZips: new Set(),
      bufferMode: false
    };

    // Initialize filters
    numericFields.forEach(f => {
      state.filters[f] = {min: null, max: null};
    });

    // Create filters UI
    const filtersDiv = document.getElementById('filters');
    numericFields.forEach(f => {
      const row = document.createElement('div');
      row.className = 'filter-row';
      
      const label = document.createElement('label');
      label.textContent = f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      
      const minInput = document.createElement('input');
      minInput.type = 'number';
      minInput.placeholder = 'min';
      minInput.step = 'any';
      
      const maxInput = document.createElement('input');
      maxInput.type = 'number';
      maxInput.placeholder = 'max';
      maxInput.step = 'any';
      
      minInput.oninput = () => {
        state.filters[f].min = minInput.value === '' ? null : +minInput.value;
        refreshMap();
        updateQuickStats();
      };
      
      maxInput.oninput = () => {
        state.filters[f].max = maxInput.value === '' ? null : +maxInput.value;
        refreshMap();
        updateQuickStats();
      };
      
      row.appendChild(label);
      row.appendChild(minInput);
      row.appendChild(maxInput);
      filtersDiv.appendChild(row);
    });

    // Calculate proper center using centroid of all polygons
    const centroid = turf.centroid(geojson);
    const centerLat = centroid.geometry.coordinates[1];
    const centerLng = centroid.geometry.coordinates[0];

    // Initialize map with calculated center
    const map = L.map('map').setView([centerLat, centerLng], 10);

    // Basemap options
    const basemaps = {
      streets: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap, Â© CartoDB'
      }),
      satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Â© Esri'
      }),
      dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: 'Â© OpenStreetMap, Â© CartoDB'
      })
    };

    let currentBasemap = basemaps.streets.addTo(map);

    // Basemap controls
    document.querySelectorAll('.basemap-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const basemapType = btn.dataset.basemap;
        map.removeLayer(currentBasemap);
        currentBasemap = basemaps[basemapType].addTo(map);
        
        // Update button states
        document.querySelectorAll('.basemap-btn').forEach(b => b.style.opacity = '0.7');
        btn.style.opacity = '1';
      });
    });

    // Set initial button state
    document.querySelector('.basemap-btn.streets').style.opacity = '1';

    // Styling
    const styleDefault = {
      color: '#667eea',
      weight: 1.5,
      fillOpacity: 0.12,
      fillColor: '#667eea'
    };
    
    const styleHighlight = {
      color: '#ef4444',
      weight: 3,
      fillOpacity: 0.4,
      fillColor: '#ef4444'
    };

    let geoLayer;

    function passesFilters(props) {
      return numericFields.every(f => {
        const val = props[f];
        const {min, max} = state.filters[f];
        if (min !== null && val < min) return false;
        if (max !== null && val > max) return false;
        return true;
      });
    }

    function buildPopup(props) {
      let html = '<table style="margin: 0; border-collapse: collapse;">';
      Object.entries(props).forEach(([k, v]) => {
        const displayKey = k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        const displayValue = typeof v === 'number' ? 
          (/_pct$/i.test(k) ? v.toFixed(2) + '%' : v.toLocaleString()) : v;
        html += `<tr><td style="padding: 6px 8px; font-weight: 600; color: #667eea;">${displayKey}</td><td style="padding: 6px 8px;">${displayValue}</td></tr>`;
      });
      html += '</table>';
      return html;
    }

    function refreshMap() {
      if (geoLayer) map.removeLayer(geoLayer);
      
      const filteredFeatures = features.filter(f => passesFilters(f.properties));
      
      geoLayer = L.geoJSON(filteredFeatures, {
        style: feature => {
          const zipCode = feature.properties[zipKey];
          if (state.selectedZips.has(zipCode)) {
            return styleHighlight;
          }
          return styleDefault;
        },
        onEachFeature: (feature, layer) => {
          layer.bindPopup(buildPopup(feature.properties));
          
          // Click to select/deselect (only when not in buffer mode)
          layer.on('click', (e) => {
            if (!state.bufferMode) {
              const zipCode = feature.properties[zipKey];
              if (state.selectedZips.has(zipCode)) {
                state.selectedZips.delete(zipCode);
              } else {
                state.selectedZips.add(zipCode);
              }
              refreshMap();
              updateSummary();
              updateQuickStats();
            }
          });
          
          // Hover effects
          layer.on('mouseover', function() {
            if (!state.selectedZips.has(feature.properties[zipKey])) {
              this.setStyle({
                weight: 3,
                fillOpacity: 0.25
              });
            }
          });
          
          layer.on('mouseout', function() {
            if (!state.selectedZips.has(feature.properties[zipKey])) {
              this.setStyle(styleDefault);
            }
          });
        }
      }).addTo(map);
    }

    // Drawing tools
    const drawnItems = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({
      edit: {featureGroup: drawnItems},
      draw: {
        marker: false,
        circle: false,
        polyline: false,
        circlemarker: false,
        polygon: {
          shapeOptions: {
            color: '#667eea',
            fillOpacity: 0.2
          }
        },
        rectangle: {
          shapeOptions: {
            color: '#667eea',
            fillOpacity: 0.2
          }
        }
      }
    });
    map.addControl(drawControl);

    function selectInShape(shape) {
      const filteredFeatures = features.filter(f => passesFilters(f.properties));
      filteredFeatures.forEach(feature => {
        try {
          if (turf.booleanIntersects(shape, feature)) {
            state.selectedZips.add(feature.properties[zipKey]);
          }
        } catch (e) {
          console.warn('Geometry intersection error:', e);
        }
      });
    }

    // Handle drawing events
    map.on(L.Draw.Event.CREATED, e => {
      const shape = e.layer.toGeoJSON();
      drawnItems.addLayer(e.layer);
      selectInShape(shape);
      refreshMap();
      updateSummary();
      updateQuickStats();
    });

    // Buffer functionality
    let bufferCircle = null;
    
    function toggleBufferMode() {
      state.bufferMode = !state.bufferMode;
      const bufferBtn = document.getElementById('bufferTool');
      
      if (state.bufferMode) {
        bufferBtn.classList.add('buffer-mode');
        bufferBtn.innerHTML = '<i class="fas fa-circle"></i>Cancel Buffer';
        map.getContainer().style.cursor = 'crosshair';
      } else {
        bufferBtn.classList.remove('buffer-mode');
        bufferBtn.innerHTML = '<i class="fas fa-circle"></i>Buffer';
        map.getContainer().style.cursor = '';
        if (bufferCircle) {
          map.removeLayer(bufferCircle);
          bufferCircle = null;
        }
      }
    }

    function performBufferSelection(latlng) {
      const radius = parseFloat(document.getElementById('bufferRadius').value) || 5;
      const radiusInMeters = radius * 1000;
      
      // Remove previous buffer circle
      if (bufferCircle) {
        map.removeLayer(bufferCircle);
      }
      
      // Create buffer circle
      bufferCircle = L.circle(latlng, {
        radius: radiusInMeters,
        color: '#f59e0b',
        fillColor: '#f59e0b',
        fillOpacity: 0.2,
        weight: 2
      }).addTo(map);
      
      // Create turf circle for intersection
      const center = turf.point([latlng.lng, latlng.lat]);
      const buffer = turf.buffer(center, radius, {units: 'kilometers'});
      
      // Select features within buffer
      const filteredFeatures = features.filter(f => passesFilters(f.properties));
      filteredFeatures.forEach(feature => {
        try {
          if (turf.booleanIntersects(buffer, feature)) {
            state.selectedZips.add(feature.properties[zipKey]);
          }
        } catch (e) {
          console.warn('Buffer intersection error:', e);
        }
      });
      
      refreshMap();
      updateSummary();
      updateQuickStats();
      toggleBufferMode(); // Exit buffer mode after selection
    }

    // Map click handler for buffer
    map.on('click', function(e) {
      if (state.bufferMode) {
        performBufferSelection(e.latlng);
      }
    });

    // Button event listeners
    document.getElementById('bufferTool').onclick = toggleBufferMode;
    
    document.getElementById('clearSel').onclick = () => {
      state.selectedZips.clear();
      drawnItems.clearLayers();
      if (bufferCircle) {
        map.removeLayer(bufferCircle);
        bufferCircle = null;
      }
      if (state.bufferMode) {
        toggleBufferMode();
      }
      refreshMap();
      updateSummary();
      updateQuickStats();
    };

    // Quick stats function
    function updateQuickStats() {
      const filteredFeatures = features.filter(f => passesFilters(f.properties));
      const selectedFeatures = filteredFeatures.filter(f => 
        state.selectedZips.has(f.properties[zipKey])
      );
      
      const quickStatsDiv = document.getElementById('quickStats');
      quickStatsDiv.innerHTML = `
        <div class="stat-card">
          <span class="stat-value">${filteredFeatures.length}</span>
          <div class="stat-label">Total Areas</div>
        </div>
        <div class="stat-card">
          <span class="stat-value">${selectedFeatures.length}</span>
          <div class="stat-label">Selected</div>
        </div>
      `;
    }

    // Correct aggregation function
    function aggregate() {
      const selectedFeatures = features.filter(f => 
        state.selectedZips.has(f.properties[zipKey]) && passesFilters(f.properties)
      );
      
      if (selectedFeatures.length === 0) return [];
      
      // Create summary row
      const summary = {[zipKey]: 'TOTAL/AVERAGE'};
      
      numericFields.forEach(field => {
        if (/_pct$/i.test(field)) {
          // Average for percentage fields
          const sum = selectedFeatures.reduce((total, feature) => total + feature.properties[field], 0);
          summary[field] = sum / selectedFeatures.length;
        } else {
          // Sum for count fields
          summary[field] = selectedFeatures.reduce((total, feature) => total + feature.properties[field], 0);
        }
      });
      
      return [summary];
    }

    let dataTable, countChart, pctChart;

    function updateSummary() {
      const data = aggregate();
      
      // Update table
      const thead = document.querySelector('#summary thead');
      const tbody = document.querySelector('#summary tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '';
      
      if (!data.length) {
        thead.innerHTML = '<tr><th style="text-align: center; padding: 20px;">No areas selected</th></tr>';
        if (countChart) countChart.destroy();
        if (pctChart) pctChart.destroy();
        return;
      }
      
      const columns = Object.keys(data[0]);
      const headerRow = document.createElement('tr');
      columns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      
      data.forEach(row => {
        const tr = document.createElement('tr');
        columns.forEach(col => {
          const td = document.createElement('td');
          if (col === zipKey) {
            td.textContent = row[col];
          } else if (/_pct$/i.test(col)) {
            td.textContent = row[col].toFixed(2) + '%';
          } else if (typeof row[col] === 'number') {
            td.textContent = Math.round(row[col]).toLocaleString();
          } else {
            td.textContent = row[col];
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      
      // Reinitialize DataTable
      if (dataTable) dataTable.destroy();
      dataTable = $('#summary').DataTable({
        pageLength: 25,
        scrollY: '400px',
        scrollCollapse: true,
        scrollX: true
      });

      // Update charts
      updateCharts(data[0]);
    }

    function updateCharts(data) {
      if (!data) return;
      
      const countFields = numericFields.filter(f => !/_pct$/i.test(f));
      const pctFields = numericFields.filter(f => /_pct$/i.test(f));
      
      // Chart colors
      const colors = [
        '#667eea', '#764ba2', '#f093fb', '#f5576c',
        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
      ];

      // Count chart
      if (countChart) countChart.destroy();
      if (countFields.length > 0) {
        const ctx = document.getElementById('countChart');
        if (ctx) {
          countChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: countFields.map(f => f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())),
              datasets: [{
                label: 'Total Count',
                data: countFields.map(f => data[f] || 0),
                backgroundColor: colors.slice(0, countFields.length),
                borderRadius: 8,
                borderSkipped: false,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: 'rgba(0,0,0,0.1)' }
                },
                x: {
                  grid: { display: false }
                }
              }
            }
          });
        }
      }

      // Percentage chart
      if (pctChart) pctChart.destroy();
      if (pctFields.length > 0) {
        const ctx = document.getElementById('pctChart');
        if (ctx) {
          pctChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: pctFields.map(f => f.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())),
              datasets: [{
                label: 'Average %',
                data: pctFields.map(f => data[f] || 0),
                backgroundColor: colors.slice(0, pctFields.length),
                borderRadius: 8,
                borderSkipped: false,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: 'rgba(0,0,0,0.1)' }
                },
                x: {
                  grid: { display: false }
                }
              }
            }
          });
        }
      }
    }

    // Initialize the dashboard
    refreshMap();
    updateQuickStats();
    updateSummary();

  } catch (error) {
    console.error('Error loading data:', error);
    document.getElementById('tools-tab').innerHTML = `
      <div class="section">
        <div style="text-align: center; color: #ef4444; padding: 30px; line-height: 1.6;">
          <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
          <h3>GeoJSON File Not Found</h3>
          <p><strong>Could not load education-data.geojson from GitHub</strong></p>
          
          <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left;">
            <h4 style="margin-top: 0; color: #667eea;"><i class="fas fa-search"></i> Debug Steps:</h4>
            
            <p><strong>1. Test if your file exists:</strong><br>
            <a href="https://centristnation.github.io/test/education-data.geojson" 
               target="_blank" style="color: #667eea; text-decoration: underline;">
               Click here to test your GeoJSON file
            </a></p>
            
            <p><strong>2. Check your file name:</strong><br>
            â€¢ Must be exactly: <code style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px;">education-data.geojson</code><br>
            â€¢ In same folder as index.html<br>
            â€¢ No extra spaces or characters</p>
            
            <p><strong>3. Check file contents:</strong><br>
            â€¢ Must be valid JSON format<br>
            â€¢ Test at: <a href="https://geojsonlint.com/" target="_blank" style="color: #667eea;">geojsonlint.com</a></p>
            
            <p><strong>4. Alternative - Embed data:</strong><br>
            Add before &lt;/script&gt;:<br>
            <code style="background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; display: block; margin-top: 8px;">
window.EDUCATION_DATA = {<br>
&nbsp;&nbsp;"type": "FeatureCollection",<br>
&nbsp;&nbsp;"features": [/* your data here */]<br>
};
            </code></p>
          </div>
          
          <p style="font-size: 14px; opacity: 0.8;">Repository: centristnation/test</p>
        </div>
      </div>
    `;
  }
})();
</script>
</body>
</html>
